<html>
    <head>
        <script src='http://cdn.html5quintus.com/v0.1.5/quintus-all.min.js'></script>
        <script src="js/behaviors.js"></script>
    </head>
    <body>
        <script>
            window.addEventListener('load', function() {

                var Q = Quintus()                          // Create a new engine instance
                        .include("Sprites, Scenes, Input, 2D, Touch, UI") // Load any needed modules
                        .include("Behaviors")
                        .setup({maximize: true})         // Add a canvas element onto the page
                        .controls()                        // Add in default controls (keyboard, buttons)
                        .touch();                          // Add in touch support (for the UI)

                Q.Sprite.extend("Player", {
                    // the init constructor is called on creation
                    init: function(p) {

                        this._super(p, {
                            sheet: "player", // Setting a sprite sheet sets sprite width and height
                            x: 80, // You can also set additional properties that can
                            y: 700,            // be overridden on object creation
                            stars: 0,
                            jumpSpeed: -600
                        });
                        
                        // Add in pre-made components to get up and running quickly
                        this.add('2d, platformerControls');

                        // Write event handlers to respond hook into behaviors.
                        // hit.sprite is called everytime the player collides with a sprite
                        this.on("hit.sprite", function(collision) {
                            // Check the collision, if it's the Tower, you win!
                            if (collision.obj.isA("Tower")) {
                                // Stage the endGame scene above the current stage
                                Q.stageScene("endGame", 1, {label: "You Won!"});
                                // Remove the player to prevent them from moving
                                this.destroy();
                            }
                        });
                    }
                });

                // Sprites can be simple, the Tower sprite just sets a custom sprite sheet
                Q.Sprite.extend("Tower", {
                    init: function(p) {
                        this._super(p, {sheet: 'tower'});
                    }
                });

                Q.Sprite.extend("Star", {
                    init: function(p) {
                        this._super(p, {sheet: 'enemy', vx: 0});

                        this.add('collectable');
                        
                        this.on('hit', function(collision) {
                            if (collision.obj.isA("Player")) {
                                collision.obj.p.stars += 1;
                            }
                        });
                    }
                });
                
                Q.Sprite.extend("Shot", {
                   init: function(p) {
                       this._super(p, {w: 3, h: 3, vx: 300, vy: 300});
                       
                       //this moves the shot straightly based on p.direction 
                       this.add('movingStraight');
                       
                       this.on('hit', function(collision) {
                           //if the shot collides with an object it will be removed
                            this.destroy();
                            
                            //if the shot collides with the player, the player is dead
                            if(collision.obj.isA("Player")) {
                                Q.stageScene("endGame",1, { label: "You Died" }); 
                                collision.obj.destroy();    
                            }
                        });
                   },
                   draw: function(ctx) {
                        //render a shot as a 3x3px box
                        ctx.fillStyle = "grey";
                        ctx.beginPath();
                        ctx.fillRect(-this.p.cx ,-this.p.cy , 3, 3);
                        ctx.fill();
                   }
                });
                
                Q.Sprite.extend("ShootingEnemy", {
                    init: function(p) {
                        this._super(p, {sheet: 'enemy', vx: 100});
                        
                        this.add('2d, aiBounce, shooting, stompable');
                    }
                });

                // Create a new scene called level 1
                Q.scene("level1", function(stage) {

                    // Add in a tile layer, and make it the collision layer
                    stage.collisionLayer(new Q.TileLayer({
                        dataAsset: 'level1.tmx',
                        sheet: 'tiles',
                        tileW: 70,
                        tileH: 70}));

                    // Create the player and add him to the stage
                    var player = stage.insert(new Q.Player());

                    // Give the stage a moveable viewport and tell it
                    // to follow the player.
                    stage.add("viewport").follow(player);

                    // Add in a couple of stars
                    //stage.insert(new Q.Star({x: 700, y: 210}));
                    stage.insert(new Q.Star({x: 800, y: 0}));
                    
                    // Add in a couple of enemies
                    stage.insert(new Q.ShootingEnemy({x: 900, y: 210, shootingDelay: 100}));

                    // test
                    //stage.insert(new Q.Shot({x: 800, y: 200, direction: 'left'}));

                    // Finally add in the tower goal
                    stage.insert(new Q.Tower({x: 180, y: 50}));
                });

                // To display a game over / game won popup box, 
                // create a endGame scene that takes in a `label` option
                // to control the displayed message.
                Q.scene('endGame', function(stage) {
                    var container = stage.insert(new Q.UI.Container({
                        x: Q.width / 2, y: Q.height / 2, fill: "rgba(0,0,0,0.5)"
                    }));

                    var button = container.insert(new Q.UI.Button({x: 0, y: 0, fill: "#CCCCCC",
                        label: "Play Again"}))
                    var label = container.insert(new Q.UI.Text({x: 10, y: -10 - button.p.h,
                        label: stage.options.label}));
                    // When the button is clicked, clear all the stages
                    // and restart the game.
                    button.on("click", function() {
                        Q.clearStages();
                        Q.stageScene('level1');
                    });

                    // Expand the container to visibily fit it's contents
                    container.fit(20);
                });

                // Q.load can be called at any time to load additional assets
                // assets that are already loaded will be skipped
                Q.load("sprites.png, sprites.json, level1.tmx, tileset.png",
                        // The callback will be triggered when everything is loaded
                                function() {
                                    // Sprites sheets can be created manually
                                    Q.sheet("tiles", "tileset.png", {tilew: 70, tileh: 70});

                                    // Or from a .json asset that defines sprite locations
                                    Q.compileSheets("sprites.png", "sprites.json");

                                    // Finally, call stageScene to run the game
                                    Q.stageScene("level1");
                                });

                        window.Q = Q;
                    }, true);
        </script>
    </body>
</html>